#! /bin/sh

set -e


##
## Usage
##
usage () {
	cat <<EOF
usage: $0 [ <options> ] [ <files> ]
<options>:
  -f  update files in current directory from configuration files
  -t  update configuration files from files in current directory
  -B  do not make backups
  -y  assume "y" to all questions
EOF
	exit 1
}


##
## Parse arguments
##
direction=
interactive=true
backup=true

while [ x"${1#-}" != x"$1" ]; do
	ARG=${1#?}
	shift
	while [ -n "$ARG" ]; do
		case "$ARG" in
		f*) direction=from   ;;
		t*) direction=to     ;;
		B*) backup=false     ;;
		y*) interactive=false;;
		?*) usage            ;;
		esac
		ARG=${ARG#?}
	done
done


##
## Color handling
##
if ! which tput >/dev/null 2>&1; then
	tput () {
		return 0
	}
fi


##
## Print info
##

case "$direction" in
from)
	tput bold
	tput setaf 7
	echo 'Updating files in current directory from configuration files'
	tput sgr0
	;;
to)
	tput bold
	tput setaf 7
	echo 'Updating configuration files from files in current directory'
	tput sgr0
	;;
*)
	usage
esac


##
## File arguments
##
if [ $# -eq 0 ]; then
	match () {
		return 0
	}
else
	match () {
		for f in "$@"; do
			case "$file" in "$f")
				return 0
			esac
		done
		return 1
	}
fi


##
## Interactive asking
##
if $interactive; then
	ask() {
		if which cdiff >/dev/null 2>&1; then
			cdiff -u "$2" "$1"
		else
			diff  -u "$2" "$1"
		fi

		while :; do
			tput bold
			tput setaf 7
			tput setab 4
			printf '%s:' "$2"
			tput sgr0
			tput setaf 7
			tput setab 4
			printf ' [yn] '
			tput sgr0
			read answer || exit 0
			case "$answer" in
			[yY]) return 0 ;;
			[nN]) return 1 ;;
			esac
		done
		echo
	}
else
	ask() {
		return 0
	}
fi


##
## Backup & copy
##
cp_backup() {
	if ! [ -e "$2" ]; then
		cp "$1" "$2"
		return 0
	elif ! cmp -s -- "$1" "$2" && ask "$1" "$2"; then
		if $backup; then
			mv -- "$2" "$2~"
		fi
		cp "$1" "$2"
		return 0
	else
		return 1
	fi
}

cp_backup_from() {
	cp_backup "$2" "$1"
}

cp_backup_to() {
	cp_backup "$@"
}

##
## Template handling
##
tempfile=$(umask 077; mktemp)
trap 'rm -f -- "$tempfile"' 0

cp_tpl_from() {
	if ! [ -e "$1" ]; then
		sed "s#$HOME#{{HOME}}#g" <$2 >$1
	else
		sed "s#{{HOME}}#$HOME#g" <$1 >$tempfile
		if cp_backup "$2" "$tempfile"; then
			sed "s#$HOME#{{HOME}}#g" <$tempfile >$1
		fi
	fi
}

cp_tpl_to() {
	if [ -e "$1" ]; then
		sed "s#{{HOME}}#$HOME#g" <$1 >$tempfile
		cp_backup "$tempfile" "$2" || true
	fi
}

##
## Emacs files handling
##
compile_el() {
	if [ -e "${1}c" ] &&
	   [ "$1" -nt  "${1}c" ] &&
	   file "${1}c" | grep -q 'Emacs.*byte-compiled' &&
	   [ -n "$(which emacs 2>/dev/null)" ]; then
		tput bold
		tput setaf 7
		echo "Compiling $1"
		tput sgr0
		emacs --batch -f batch-byte-compile "$1"
	fi
}


##
## Do the job
##
handle() {
	if match "$@"; then
		case "$dest" in '~'*)   dest=$HOME${dest#'~'}; esac
		case "$dest" in *@)     dest=${dest%@}${file##*/}; esac
		case "$dest" in */.|*/) dest=$dest$file; esac

		if ! [ -d "${dest%/*}" ]; then
			tput setaf 6
			echo "Skipping $file, ${dest%/*}/ missing"
			tput sgr0
			return 0
		fi

		case "$file" in
		*.tpl)
			dest=${dest%.tpl}
			cp_tpl_$direction "$file" "$dest" <&3
			;;
		*)
			cp_backup_$direction "$file" "$dest" <&3 || true
		esac
		case "$dest:$direction" in *.el:to)
			compile_el "$dest"
		esac
	fi
}

if [ $direction = to ]; then
	mkdir -p ~/bin/libexec ~/.config/git ~/.config/xkb/keymap \
	      ~/.config/xkb/symbols
fi

while read file dest; do
	case $file in
	*'*'*)
		for file in $file; do
			if [ -f "$file" ]; then
				case $file in *~)
					continue
				esac
				_dest=$dest
				handle "$@"
				dest=$_dest
			fi
		done
		;;
	*)
		handle "$@"
	esac
done 3<&1 <<EOF
emacs/*            ~/.emacs.d/@
mail/*             ~/.mail/@
git/*              ~/.config/git/@
inputrc            ~/.
irssi.theme        ~/.irssi/mina.theme
sawfishrc          ~/.sawfish/rc
statuses           ~/.irssi/
bin/*              ~/
bin/libexec/*      ~/
sh/*               ~/.@
dir-colors         ~/.dir_colors
vimperatorrc       ~/.vimperator/rc
x/Xresources.tpl   ~/.config/@
x/gtkrc-2.0        ~/.@
x/xinitrc          ~/.@
x/xserverrc        ~/.@
x/local.keymap     ~/.config/xkb/keymap/local
x/local.symbols    ~/.config/xkb/symbols/local
x/80-char.png      ~/.urxvt/@
EOF
