#! /bin/sh
# $Id: update,v 1.5 2008/05/23 09:22:40 mina86 Exp $

set -e


INTERACTIVE=
case "$1" in (-[iI])
	INTERACTIVE=${1#-}
	shift
esac


DIRECTION=
case "$1" in
(from|to)
	DIRECTION=$1
	shift
	;;
(*)
	echo 'usage: ./update [ -i | -I ] ( to | from ) [ <files> ]'
	exit 1
esac


if [ $DIRECTION = from ]; then
	echo 'Updating files in current directory from configuration files'
else
	echo 'Updating configuration files from files in current directory'
fi

if [ -z "$INTERACTIVE" ]; then
	printf 'Do you want to continue? [y/N] '
	read answer || exit 0
	if ! read answer; then
		exit 0
	elif [ X"${answer#[yY]}" = X"${answer}" ]; then
		exit 0
	fi
fi



if [ $# -eq 0 ]; then
	match () {
		true
	}
else
	match () {
		for f in "$@"; do
			if [ X"$FILE" = X"$f" ]; then return 0; fi
		done
		false
	}
fi


if [ -n "$INTERACTIVE" ]; then
	difference () {
		case "$1" in ([dD])
			set -- r "$3" "$2"
		esac
		if which cdiff >/dev/null 2>&1; then
			cdiff -u "$2" "$3"
		else
			diff  -u "$2" "$3"
		fi
	}

	ask () {
		while :; do
			printf '%s: [yndre?] ' "$2"
			read answer || exit 0
			case "$answer" in
			([yY]) return 0 ;;
			([nN]) return 1 ;;
			([dDrR]) difference $answer "$1" "$2" ;;
			([eE]) exit 0 ;;
			('?') echo 'y - copy, n - skip, d - diff, r - reverse diff, e - exit'
			esac
		done
	}
else
	ask() {
		true
	}
fi


cp_backup () {
	if [ -e "$2" ]; then
		if ! cmp -s -- "$1" "$2" && ask "$1" "$2"; then
			mv -- "$2" "$2~"
			cp -- "$1" "$2"
		fi
	elif [ x$INTERACTIVE != xI ] || ask "$1" "$2"; then
		cp -- "$1" "$2"
	fi
}


while read FILE DEST; do
	match "$@" || continue
	case "$DEST" in ('~'*)   DEST=$HOME${DEST#'~'}; esac
	case "$DEST" in (*/.|*/) DEST=$DEST$FILE;       esac

	if ! [ -d "${DEST%/*}" ]; then
		echo "Skipping $FILE"
	elif [ $DIRECTION = from ]; then
		cp_backup "$DEST" "$FILE" <&3
	else
		cp_backup "$FILE" "$DEST" <&3
	fi
done 3<&1 <<EOF
bash_profile       ~/.
bashrc             ~/.
dot-emacs          ~/.emacs.d/init.el
dot-gnus           ~/.gnus/.gnus.el
profile            ~/.
risc-mode.el       ~/.emacs.d/elisp/
sawfishrc          ~/.
shellrc            ~/.
xinitrc            ~/.
zlogin             ~/.
zshrc              ~/.
EOF
