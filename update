#! /bin/sh

set -e


##
## Usage
##
usage () {
	cat <<EOF
usage: $0 [ <options> ] [ <files> ]
<options>:
  -f  updat files in current directory from configuration files
  -t  updat configuration files from files in current directory
  -b  make backup (default)        -B  do not make backups
  -i  interactive (default)        -I  not interactive
EOF
	exit 1
}


##
## Parse arguments
##
DIRECTION=
INTERACTIVE=yes
BACKUP=yes

while [ x"${1#-}" != x"$1" ]; do
	ARG=${1#?}
	shift
	while [ -n "$ARG" ]; do
		case "$ARG" in
		f*) DIRECTION=from ;;
		t*) DIRECTION=to   ;;
		b*) BACKUP=yes     ;;
		B*) BACKUP=        ;;
		i*) INTERACTIVE=yes;;
		I*) INTERACTIVE=   ;;
		?*) usage          ;;
		esac
		ARG=${ARG#?}
	done
done

[ -n "$DIRECTION" ] || usage


##
## Print info
##
case "$DIRECTION" in
from) echo 'Updating files in current directory from configuration files' ;;
to)   echo 'Updating configuration files from files in current directory' ;;
*)    usage
esac

case "$INTERACTIVE" in '')
	printf 'Do you want to continue? [y/N] '
	if ! read answer; then
		exit 0
	elif [ X"${answer#[yY]}" = X"${answer}" ]; then
		exit 0
	fi
esac


##
## File arguments
##
if [ $# -eq 0 ]; then
	match () {
		return 0
	}
else
	match () {
		for f in "$@"; do
			case "$FILE" in "$f")
				return 0
			esac
		done
		return 1
	}
fi


##
## Interactive asking
##
if [ -n "$INTERACTIVE" ]; then
	difference () {
		case "$1" in [dD])
			set -- r "$3" "$2"
		esac
		if which cdiff >/dev/null 2>&1; then
			cdiff -u "$2" "$3"
		else
			diff  -u "$2" "$3"
		fi
	}

	ask () {
		while :; do
			printf '%s: [yndre?] ' "$2"
			read answer || exit 0
			case "$answer" in
			[yY]) return 0 ;;
			[nN]) return 1 ;;
			[dDrR]) difference $answer "$1" "$2" ;;
			[eE]) exit 0 ;;
			'?') echo 'y - copy, n - skip, d - diff, r - reverse diff, e - exit'
			esac
		done
	}
else
	ask() {
		return 0
	}
fi


##
## Backup & copy
##
case "$BACKUP" in
yes)
	cp_backup () {
		if ! [ -e "$2" ]; then
			cp -v -- "$1" "$2"
		elif ! cmp -s -- "$1" "$2" && ask "$1" "$2"; then
			mv -- "$2" "$2~"
			cp -v -- "$1" "$2"
		fi
	}
	;;
*)
	cp_backup () {
		if ! [ -e "$2" ]; then
			cp -v -- "$1" "$2"
		elif ! cmp -s -- "$1" "$2" && ask "$1" "$2"; then
			cp -v -- "$1" "$2"
		fi
	}
esac


##
## Do the job
##
handle() {
	if match "$@"; then
		case "$DEST" in '~'*)   DEST=$HOME${DEST#'~'}; esac
		case "$DEST" in */@)    DEST=${DEST%@}${FILE##*/}; esac
		case "$DEST" in */.|*/) DEST=$DEST$FILE; esac
		if ! [ -d "${DEST%/*}" ]; then
			echo "Skipping $FILE"
		else
			case "$DIRECTION" in
			from) cp_backup "$DEST" "$FILE" <&3 ;;
			to)   cp_backup "$FILE" "$DEST" <&3 ;;
			esac
		fi
	fi
}

while read FILE DEST; do
	case $FILE in
	*'*'*)
		for FILE in $FILE; do
			if [ -f "$FILE" ]; then
				case $FILE in *~)
					continue
				esac
				_DEST=$DEST
				handle "$@"
				DEST=$_DEST
			fi
		done
		;;
	*)
		handle "$@"
	esac
done 3<&1 <<EOF
Xresources         ~/.
bash_profile       ~/.
bashrc             ~/.
dot-emacs          ~/.emacs.d/init.el
dot-gnus           ~/.gnus/.gnus.el
gitconfig          ~/.
irssi.theme        ~/.irssi/mina.theme
profile            ~/.
risc-mode.el       ~/.emacs.d/elisp/
sawfishrc          ~/.
shellrc            ~/.
statuses           ~/.irssi/
xinitrc            ~/.
zshrc              ~/.
bin/*              ~/
userjs/*.js        ~/.opera/
opera/*.css        ~/.opera/usercss/@
opera/keyboard.ini ~/.opera/keyboard/@
opera/menu.ini     ~/.opera/menu/@
opera/toolbar.ini  ~/.opera/toolbar/@
EOF
