#!/bin/sh

## MPD
_mpc() {
	mpc --format '[[[%artist% <&%album%> ]|[%artist% - ]|[<%album%> ]]%title%]|[%file%]' "$@" | head -n 1
}

mpd_file() {
	FILE="/data/music/$(mpc --format %file% |head -n1)"
}

mpd_ctl() {
	case ${1:-show} in
	play|pause|stop|prev|toggle|next)
		_mpc "$@"
		;;
	rewind)
		_mpc seek 0:00:00
		;;
	is-playing)
		mpc -f '' | grep -wq playing
		;;
	file|path)
		mpd_file
		echo "$FILE"
		;;
	dir)
		mpd_file
		dirname "$FILE"
		;;
	ls)
		mpd_file
		DIR=$(dirname "$FILE")
		printf %s:\\n "$DIR"
		ls -- "$DIR"
		;;
	tag)
		mpd_file
		if ! [ -f "$FILE" ]; then
			printf '%s: file does not exists\n' "$MP3_DIR/$FILE"
			exit 2
		fi
		chmod 755 -- "$FILE"
		echo "$FILE"
		_mpc next
		;;
	show)
		_mpc
		;;
	*)
		echo "unknown or unsupported action: $1"
		return 1
	esac
}


## Spotify
spotify_cmd() {
	dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
		/org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.$1 \
		>/dev/null
}

spotify_query() {
	qdbus org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 \
		org.freedesktop.DBus.Properties.Get \
		org.mpris.MediaPlayer2.Player PlaybackStatus
}

spotify_ctl() {
	case ${1:-show} in
	play)
		spotify_cmd Play
		;;
	pause)
		spotify_cmd Pause
		;;
	toggle)
		spotify_cmd PlayPause
		;;
	next)
		spotify_cmd Next
		;;
	prev)
		spotify_cmd Previous
		;;
	stop)
		spotify_cmd Stop
		;;
	is-playing)
		spotify_query | grep -wq Playing
		;;
	*)
		echo "unknown or unsupported action: $1"
		return 1
	esac
}

## Main part
if spotify_query >/dev/null 2>&1; then
	player=spotify
else
	player=mpd
fi

if [ -e ~/bin/libexec/"music-$player-$1" ]; then
	source ~/bin/libexec/"music-$player-$1"
	exit $?
fi

case $1 in
pause-maybe)
	if ${player}_ctl is-playing; then
		${player}_ctl pause
		exit 0
	else
		exit 1
	fi
	;;
*)
	${player}_ctl "$@"
	exit $?
esac
