#!/bin/sh

have() {
	have=`which "$1" 2>/dev/null` && test -n "$have"
}

if [ -e /etc/slackware-version ]; then
	cmd=slack
elif have apt || have apt-get || have yum; then
	cmd=$have
else
	echo "a: could not find package manager software" >&2
	exit 1
fi

if [ 0 -eq $(id -u) ]; then
	sudo=
elif have sudo; then
	sudo=sudo
elif have s; then
	sudo=s
else
	echo 'a: s or sudo required' >&2
	exit 1
fi

# Normalise command by removing full path and collapse ‘apt’ and ‘apt-get’ into
# a single entry.
normalised=${cmd##*/}
normalised=${normalised%-get}

# If "$1" is not one of the known commands, assume install.  Also do some
# mapping so yum commands look more like apt-get commands.  I have nothing
# against yum but I'm more used to apt-get.
case "${normalised##*/}:$1" in
yum:remove|yum:purge)
	shift
	set -- erase "$@"
	;;

yum:--help)
	shift
	set -- help "$@"
	;;

yum:check | \
yum:check-update | \
yum:clean | \
yum:deplist | \
yum:distribution-synchronization | \
yum:downgrade | \
yum:groupinfo | \
yum:groupinstall | \
yum:grouplist | \
yum:groupremove | \
yum:history | \
yum:info | \
yum:install | \
yum:list | \
yum:load-transaction | \
yum:makecache | \
yum:provides | \
yum:reinstall | \
yum:repolist | \
yum:resolvedep | \
yum:search | \
yum:shell | \
yum:update-minimal | \
yum:updateinfo | \
yum:upgrade | \
yum:help | \
apt:install | \
apt:remove | \
apt:hold | \
apt:unhold | \
apt:markauto | \
apt:unmarkauto | \
apt:forbid-version | \
apt:update | \
apt:upgrade | \
apt:safe-upgrade | \
apt:full-upgrade | \
apt:forget-new | \
apt:search | \
apt:show | \
apt:clean | \
apt:autoclean | \
apt:changelog | \
apt:download | \
apt:reinstall | \
apt:why | \
apt:why-not)
	;;

apt:purge)
	shift
	set -- remove --purge --auto-remove "$@"
	;;

yum:?*|apt:?*)
	set -- install "$@"
	;;

slack:remove|slack:purge)
	shift
	cmd=removepkg
	;;
slack:upgrade|slack:update)
	shift
	cmd=upgradepkg
	;;
slack:?*.t?z)
	cmd=upgradepkg
	set -- --install-new "$@"
	;;

*)
	echo 'a: do not know what to do' >&2
	exit 1
esac

echo "+" "$cmd" "$@" >&2
$sudo "$cmd" "$@"
if [ $# -eq 1 ] && have apt-file && [ x"$1" = xupdate ]; then
	exec $sudo apt-file update
fi
