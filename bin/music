#!/bin/sh

## MPD
mpd_ctl() {
	case $1 in
	play|pause|stop|prev|toggle|next)
		mpc "$@"
		;;
	rewind)
		mpc seek 0:00:00
		;;
	tag)
		source ~/bin/libexec/music-tag
		;;
	is-playing)
		mpc -f '' | grep -wq playing
		;;
	*)
		echo "unknown action: $1"
		return 1
	esac
}


## Spotify
spotify_cmd() {
	dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
		/org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.$1 \
		>/dev/null
}

spotify_query() {
	qdbus org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 \
		org.freedesktop.DBus.Properties.Get \
		org.mpris.MediaPlayer2.Player PlaybackStatus
}

spotify_ctl() {
	case "$1" in
	play)
		spotify_cmd Play
		;;
	pause)
		spotify_cmd Pause
		;;
	toggle)
		spotify_cmd PlayPause
		;;
	next)
		spotify_cmd Next
		;;
	prev)
		spotify_cmd Previous
		;;
	stop)
		spotify_cmd Stop
		;;
	rewind|tag)
		echo "$1: unsupported with Spotify"
		;;
	is-playing)
		spotify_query | grep -wq Playing
		;;
	*)
		echo "unknown action: $1"
		return 1
	esac
}

## Main part
if spotify_query >/dev/null 2>&1; then
	ctl=spotify_ctl
else
	ctl=mpd_ctl
fi

case $1 in
pause-maybe)
	if $ctl is-playing; then
		$ctl pause
		exit 0
	else
		exit 1
	fi
	;;
*)
	$ctl  "$@"
	exit $?
esac
